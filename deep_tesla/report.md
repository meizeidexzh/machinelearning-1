# 机器学习纳米学位
##自动驾驶汽车深度学习: DeepTesla
杨奕

2018年2月9日


## I. 问题的定义

### 项目概述

自动驾驶是近年来人工智能研究领域里比较热门及相对成熟的技术，已经有很多实用的产品出现，如特斯拉的自动辅助驾驶系统AutoPilot，百度的Apollo自动驾驶系统，英伟达自动驾驶技术及解决方案。麻省理工还专门开了一个公开课讲授自动驾驶技术（MIT 6.S094 ），这门课程包括DeepTraffic，DeepTesla等部分，其中DeepTraffic主要是通过强化学习训练车辆识别信号灯、障碍物，而DeepTesla主要是使用深度学习的图像识别技术控制车辆行驶的方向，就是根据人类驾驶或机器驾驶录制的车辆前方视频及相应的车辆转弯角度数据来训练的端到端的汽车自动驾驶，即通过车辆行驶前方图像来控制车辆运行方向。

自动驾驶技术包括很多方面，而通过模仿人类视觉观察道路来判断驾驶方向是其中最基础的功能。以往可能需要开发各种算法来判断道路方向，但在深度学习时代则可直接根据看到的道路图形，稍加处理甚至不用处理就能通过卷积神经网络和深度神经网络得到行驶方向，这种端到端的学习技术是人工智能发展必然方向。

这个项目的训练数据就是来源于这个公开课，包括十段汽车实际行驶的视频及记录的转向角度。我们要开发深度网络模型，使用这些视频的作为训练集和验证集来训练模型，使训练好的模型在输入一个新的道路图形时能尽可能正确判断行驶方向。

### 问题陈述

人类驾驶车辆在道路上行驶是通过眼睛来观察道路的弯曲程度，然后通过大脑处理后控制手来操控方向盘改变行车角度。深度学习的计算机视觉也可以达到这种程度，即通过计算机视觉对大量实际道路的行驶训练来学习到模型，通过这个模型可以计算出不同道路场景下车俩行驶的角度，从而达到与人类驾驶相同的效果。这种通过图像直接判断行驶方向的端到端的自动驾驶技术，如果模型设计合理及通过大量数据的训练应该可以达到或超过人类的驾驶水平。

这个项目需要使用计算机视觉技术来识别道路，是一个典型的图形识别问题，现在使用多层卷积神经网络已经可以达到很高的准确率，但这个项目不同的是预测的结果不是图形分类，而是道路弯曲的角度，因此需要将图像识别最终转换为线性回归问题。

项目开始时我们要将数据划分为训练集、验证集和测试集，并对数据进行一定的剪裁，在图像识别方面可以使用目前比较成熟的迁移学习方法，如使用VGG16,RESNET等模型的结构和权重对我们的训练集进行训练，由于这些模型主要是用于图像分类的，因此需要对顶部的全连接层和输出层进行改造，使用线性回归的激活函数拟合标注数据，在我们这里是转向角度。使用均方误差mse目标函数对数据进行多轮训练后，记录和跟踪训练集和验证集的损失率loss，直到损失率逐渐收敛，在训练过程中还要不断调整参数，使模型达到最优结果。最后可以通过项目提供给的实用工具代码对测试数据进行测试，生成预测结果并合成视频，可以直观的看到最后训练结果与实际角度的差距。

由于这个项目的训练数据很少，对道路转向的图像识别相对更复杂，因此最终模型很难达到能够实际应用的程度，这里主要是验证通过卷积神经网络实现端到端的自动驾驶的合理性，预测结果与实际结果的转向角度的大致趋势相同，在与训练数据相识的场景中的使用能达到一定的精度。

### 评价指标
由于这个项目是深度网络的回归问题，因此我们使用MSE方法对损失率进行测试，MSE为预测结果与真实结果的均方误差，MSE的公式如下：
$$
MSE=\frac{1}{n}\sum_{i=1}^{n}\left (Y_i - \widetilde{Y_i}\right)^{^{2}}
$$
另外还可以通过计算测试视频的预测结果与实际结果的决定系数R2,R2表示目标变量的预测值和实际值之间的相关程度平方的百分比，正常情况下这个系数在0-1之间，越接近1越好，R2的公式推导如下：

$$
SStot=\sum_{i}\left (y_i-\widetilde{y_i}\right )^{^{2}}
$$

$$
SS_\text{res}=\sum_i (y_i - f_i)^2=\sum_i e_i^2\
$$

$$
R^2 \equiv 1 - {SS_{\rm res}\over SS_{\rm tot}}
$$

## II. 分析
### 数据的探索

这个项目的训练数据同样来自MIT 6.S094课程，其中epochs目录下包括10段在多种道路上行驶的视频，文件从epoch01_front到epoch10_front，格式为mkv，这些视频可以直接通过视频软件播放。
另有10个对应的控制信号 CSV格式文件，文件的内容为ts_micro时间戳，frame_index帧编号，wheel转向角度（以水平方向为基准，+为顺时针，-为逆时针），这里对我们有用的是wheel，即训练数据的标注信息。其中视频文件中的每一帧在csv文件中都有对应的转向角度。
我们训练时就是读取视频文件中的每一帧图像作为特征数据，其对应的转向角度作为标注来训练。每帧图片大小为720x1280x3，在实际使用中要进行剪裁，每个视频文件的情况如下，可以看出视频包括不同的道路情况：

| 文件              | 帧数 | 场景                       | 是否自动驾驶 |
| ----------------- | ---- | -------------------------- | ------------ |
| epoch01_front.mkv | 1500 | 高速公路，前方车俩少       | 是           |
| epoch02_front.mkv | 3900 | 高速公路，前方车辆较多     | 是           |
| epoch03_front.mkv | 2700 | 桥梁上                     | 否           |
| epoch04_front.mkv | 2700 | 弯路多                     | 否           |
| epoch05_front.mkv | 2700 | 二车道，在里侧通行         | 否           |
| epoch06_front.mkv | 2700 | 傍晚，在里侧通行，有隔离网 | 否           |
| epoch07_front.mkv | 2700 | 在中间车道通行，两边是树木 | 是           |
| epoch08_front.mkv | 2700 | 二车道，在里侧通行         | 否           |
| epoch09_front.mkv | 2700 | 在中间车道通行，两边是树木 | 是           |
| epoch10_front.mkv | 2700 | 在中间车道通行，两边是树木 | 是           |

如果直接使用原视频图片大小，需要使用大量内存，训练系统资源有限可能无法完成训练，因此我们需要对图片进行剪裁，剪切掉视频顶部1/3的位置和底部150像素(车头部位)，同时将图片大小调整为64x64x3。下面截取视频04的6副图片样本如下：

![](C:\machinelearning\deep_tesla\images\样本.png)

### 探索性可视化

车辆行驶的转向是与道路的弯曲程度相关的，这里对车辆前方图片的识别就是要判断道路弯曲程度，在训练模型前我们需要先观察一下转向角度的范围，从所有10个视频的CSV文件提取的角度分布如下图：

![](C:\machinelearning\deep_tesla\images\all_angel.png)

可以看到数据大部分集中在-6.5度到3.5度之间，其中-3度占据的数量最多

另外对每个视频的角度分布进行分析，可以了解视频之间的差距，下图是01-10视频文件的转向角度曲线分析：

![](C:\machinelearning\deep_tesla\images\line.png)

可以看到04、05、06、08的转向角度差异很大，其余则比较平稳。

### 算法和技术

对于行车道路的识别是一个典型的图像识别技术，目前最成熟的技术是深度学习中的卷积神经网络，卷积神经网络是通过设置多层的卷积层、池化层、非线性激活函数，将数据输入层高层信息抽取出来，逐层抽象。在这里卷积的作用是进行特征提取，有研究已经表明，通过卷积层的操作各层得到的深度特征会逐渐从泛化特征（如：边缘、方向）过度到高级特征（如：车轮、文字），对于我们的项目则是识别出道路边缘、道路方向和其他车辆、警示牌等障碍物。

目前一些厂商和研究机构已经给出了一些解决方案，如下图NVIDIA提供的方案：

![](C:\machinelearning\deep_tesla\images\nvidia.png)

这个方案首先对数据做了归一化处理，然后使用了3个5x5的卷积核及2个3x3的卷积核进行特征抽取，对数据进行平化处理后，用3个全连接层进行特征映射处理，由于这里是回归问题，因此输出层使用的只有一个神经元的线性激活函数。整个模型共有2千7百万个连接 和25万个参数。

另一种比较成熟图形识别技术是迁移学习，就是利用已经训练好的模型的结构和权重，对我们的数据集进行训练，通过这种方式可以加快并优化模型的学习效率不用从零学习。迁移学习选用的模型一般都是业界公认准确率高的模型，如下图中的VGG16模型：

![](C:\machinelearning\deep_tesla\images\vgg16.png)

VGG16模型共有1亿3千万个参数，输入图形大小最小为32x32x3，卷积核的大小都为3x3，共有5个卷积层，每层的深度分别为64、128、256、256、512、512、512、512。每层之间使用了2x2的最大池化层。

### 基准模型

从2012年的AlexNet到2015年的Residual Net，卷积神经网络的准确率越来越高，因此我们可以模仿或直接采用一个已有的模型来训练数据。根据此项目对于图像数据的要求及资源的限制，准备采用对资源要求较小而准确率稍高高的VGG16模型进行迁移学习，以达到良好的训练效果。同时还可以结合了上节提到的Nvidia关于端到端自动驾驶的模型，在卷积层使用特征提取部分使用VGG16模型的迁移学习方法，但使用该模型的全连接层，在全连接层则使用Nvidia模型中的参数配置，同时为了加快模型训练和防止过拟合，使用0.5的Dropout层。

## III. 方法
_(大概 3-5 页）_

### 数据预处理
在这一部分， 你需要清晰记录你所有必要的数据预处理步骤。在前一个部分所描述的数据的异常或特性在这一部分需要被更正和处理。需要考虑的问题有：
- _如果你选择的算法需要进行特征选取或特征变换，你对此进行记录和描述了吗？_
- _**数据的探索**这一部分中提及的异常和特性是否被更正了，对此进行记录和描述了吗？_
- _如果你认为不需要进行预处理，你解释个中原因了吗？_

### 执行过程
在这一部分， 你需要描述你所建立的模型在给定数据上执行过程。模型的执行过程，以及过程中遇到的困难的描述应该清晰明了地记录和描述。需要考虑的问题：
- _你所用到的算法和技术执行的方式是否清晰记录了？_
- _在运用上面所提及的技术及指标的执行过程中是否遇到了困难，是否需要作出改动来得到想要的结果？_
- _是否有需要记录解释的代码片段(例如复杂的函数）？_

### 完善
在这一部分，你需要描述你对原有的算法和技术完善的过程。例如调整模型的参数以达到更好的结果的过程应该有所记录。你需要记录最初和最终的模型，以及过程中有代表性意义的结果。你需要考虑的问题：
- _初始结果是否清晰记录了？_
- _完善的过程是否清晰记录了，其中使用了什么技术？_
- _完善过程中的结果以及最终结果是否清晰记录了？_


## IV. 结果
_（大概 2-3 页）_

### 模型的评价与验证
在这一部分，你需要对你得出的最终模型的各种技术质量进行详尽的评价。最终模型是怎么得出来的，为什么它会被选为最佳需要清晰地描述。你也需要对模型和结果可靠性作出验证分析，譬如对输入数据或环境的一些操控是否会对结果产生影响（敏感性分析sensitivity analysis）。一些需要考虑的问题：
- _最终的模型是否合理，跟期待的结果是否一致？最后的各种参数是否合理？_
- _模型是否对于这个问题是否足够稳健可靠？训练数据或输入的一些微小的改变是否会极大影响结果？（鲁棒性）_
- _这个模型得出的结果是否可信？_

### 合理性分析
在这个部分，你需要利用一些统计分析，把你的最终模型得到的结果与你的前面设定的基准模型进行对比。你也分析你的最终模型和结果是否确确实实解决了你在这个项目里设定的问题。你需要考虑：
- _最终结果对比你的基准模型表现得更好还是有所逊色？_
- _你是否详尽地分析和讨论了最终结果？_
- _最终结果是不是确确实实解决了问题？_


## V. 项目结论
_（大概 1-2 页）_

### 结果可视化
在这一部分，你需要用可视化的方式展示项目中需要强调的重要技术特性。至于什么形式，你可以自由把握，但需要表达出一个关于这个项目重要的结论和特点，并对此作出讨论。一些需要考虑的：
- _你是否对一个与问题，数据集，输入数据，或结果相关的，重要的技术特性进行了可视化？_
- _可视化结果是否详尽的分析讨论了？_
- _绘图的坐标轴，标题，基准面是不是清晰定义了？_


### 对项目的思考
在这一部分，你需要从头到尾总结一下整个问题的解决方案，讨论其中你认为有趣或困难的地方。从整体来反思一下整个项目，确保自己对整个流程是明确掌握的。需要考虑：
- _你是否详尽总结了项目的整个流程？_
- _项目里有哪些比较有意思的地方？_
- _项目里有哪些比较困难的地方？_
- _最终模型和结果是否符合你对这个问题的期望？它可以在通用的场景下解决这些类型的问题吗？_


### 需要作出的改进
在这一部分，你需要讨论你可以怎么样去完善你执行流程中的某一方面。例如考虑一下你的操作的方法是否可以进一步推广，泛化，有没有需要作出变更的地方。你并不需要确实作出这些改进，不过你应能够讨论这些改进可能对结果的影响，并与现有结果进行比较。一些需要考虑的问题：
- _是否可以有算法和技术层面的进一步的完善？_
- _是否有一些你了解到，但是你还没能够实践的算法和技术？_
- _如果将你最终模型作为新的基准，你认为还能有更好的解决方案吗？_

----------
** 在提交之前， 问一下自己... **

- 你所写的项目报告结构对比于这个模板而言足够清晰了没有？
- 每一个部分（尤其**分析**和**方法**）是否清晰，简洁，明了？有没有存在歧义的术语和用语需要进一步说明的？
- 你的目标读者是不是能够明白你的分析，方法和结果？
- 报告里面是否有语法错误或拼写错误？
- 报告里提到的一些外部资料及来源是不是都正确引述或引用了？
- 代码可读性是否良好？必要的注释是否加上了？
- 代码是否可以顺利运行并重现跟报告相似的结果？

[]: 

